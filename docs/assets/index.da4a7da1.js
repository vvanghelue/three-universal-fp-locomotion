import{d as e,R as t,M as n,D as o,a as i,c as r,V as s,O as a,C as c,G as l,S as d,b as u,P as p,W as y,s as m,H as f,e as w,F as g,f as h,T as v,g as b}from"./vendor.109d7a8f.js";let x,k;!function(e=".",t="__import__"){try{self[t]=new Function("u","return import(u)")}catch(n){const o=new URL(e,location),i=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((n,r)=>{const s=new URL(e,o);if(self[t].moduleMap[s])return n(self[t].moduleMap[s]);const a=new Blob([`import * as m from '${s}';`,`${t}.moduleMap['${s}']=m;`],{type:"text/javascript"}),c=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){r(new Error(`Failed to import: ${e}`)),i(c)},onload(){n(self[t].moduleMap[s]),i(c)}});document.head.appendChild(c)})),self[t].moduleMap={}}}("assets/");let S={};async function L(e){let r,s;if("tracked-pointer"==e.targetRayMode)return r=new t(.02,.04,32),s=new n({opacity:.5,transparent:!0,side:o}),new i(r,s)}let j;const E={left:null,right:null};function R(t){const n={active:!1,touchIdentifier:null,touchStartPosition:{x:0,y:0},innerCirclePosition:{x:0,y:0},vector:{x:0,y:0}};let o=r({},n);const i=document.createElement("div");i.classList.add("joystick-zone"),i.innerHTML='\n        <div class="joystick">\n        </div>\n        <div class="inner-circle"></div>\n    ';const s=i.querySelector(".joystick"),a=i.querySelector(".inner-circle");async function c(){i.classList.add("animate-joystick-start-position"),"left"===t&&(i.style.left="15px",s.style.top="75vh",s.style.left="20vw",a.style.top="75vh",a.style.left="20vw"),"right"===t&&(i.style.right="15px",s.style.top="75vh",s.style.left="80vw",a.style.top="75vh",a.style.left="80vw"),await e(200),i.classList.remove("animate-joystick-start-position")}function l({x:e,y:t}){a.style.top=`${t}px`,a.style.left=`${e}px`}return c(),s.style.bottom="20vh",a.style.bottom="20vh",i.addEventListener("touchstart",(e=>{s.classList.add("active"),a.classList.add("active"),o.active||(o.active=!0,o.touchIdentifier=e.targetTouches[0].identifier,o.touchStartPosition.x=e.targetTouches[0].pageX,o.touchStartPosition.y=e.targetTouches[0].pageY,function({x:e,y:t}){s.style.top=`${t}px`,s.style.left=`${e}px`}(o.touchStartPosition),l(o.touchStartPosition))})),i.addEventListener("touchmove",(e=>{if(o.active){let t;for(let r=0;r<e.touches.length;r++)if(e.touches[r].identifier===o.touchIdentifier){t=e.touches[r];break}if(!t)return;const n={x:t.pageX,y:t.pageY},i=function({point:e,circleCenter:t,radius:n}){e.x,t.x,e.y,t.y;const o=Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)),i=(o-n)/o;return!(i<=0)&&{x:e.x+(t.x-e.x)*i,y:e.y+(t.y-e.y)*i}}({point:n,circleCenter:o.touchStartPosition,radius:80});i?(o.innerCirclePosition.x=i.x,o.innerCirclePosition.y=i.y):(o.innerCirclePosition.x=n.x,o.innerCirclePosition.y=n.y),o.vector=function({center:e,point:t,radius:n}){return{x:(t.x-e.x)/n,y:-1*(t.y-e.y)/n}}({center:o.touchStartPosition,point:o.innerCirclePosition,radius:80}),l(o.innerCirclePosition)}})),i.addEventListener("touchend",(()=>{o=r({},n),setTimeout(c,100),s.classList.remove("active"),a.classList.remove("active")})),{getVector:()=>o.vector,element:i}}const P=document.createElement("style");P.innerHTML='\n    .virtual-joysticks {\n        position: fixed;\n        left: 0;\n        bottom: 0;\n    }\n    .virtual-joysticks .joystick-zone {\n        background: rgba(0, 255, 0, .3);\n        position: fixed;\n        bottom: 10px;\n        width: calc(35vw - 30px);\n        height: calc(55vh - 30px);\n    }\n    .virtual-joysticks .joystick {\n        width: 1px;\n        height: 1px;\n        position: fixed;\n        transition: opacity 500ms ease;\n        opacity: .3;\n    }\n    .virtual-joysticks .joystick:after {\n        content: "";\n        display:block;\n        width: 160px;\n        height: 160px;\n        background: rgba(255, 255, 255, .2);\n        border: 2px solid rgba(255, 255, 255, .6);\n        border-radius: 50%;\n        transform: translate3d(-50%,-50%,0);\n    }\n    .virtual-joysticks .inner-circle {\n        width: 1px;\n        height: 1px;\n        position: fixed;\n        transition: opacity 500ms ease;\n        opacity: .5;\n    }\n    .virtual-joysticks .inner-circle:after {\n        content: "";\n        display:block;\n        width: 50px;\n        height: 50px;\n        background: rgba(255, 255, 255, .4);\n        border-radius: 50%;\n        transform: translate3d(-50%,-50%,0);\n    }\n\n    .animate-joystick-start-position .joystick,\n    .animate-joystick-start-position .inner-circle {\n        transition: 200ms ease;\n    }\n    .virtual-joysticks .joystick.active {\n        opacity: 1;\n    }\n    .virtual-joysticks .inner-circle.active {\n        opacity: 1;\n    }\n',document.head.appendChild(P);let C={};const M=window.inputSystem={initXRSession:async function({renderer:t,rig:n,camera:o}){if(x=o,t.xr.enabled=!0,k=await navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor","hand-tracking"]}),!k)return console.log("session not there"),void alert("XR Session not started");k.addEventListener("end",(function(){console.log("session end"),k=null})),t.xr.setSession(k);for(const e of[0,1]){const o=t.xr.getController(e);o.addEventListener("connected",(async function(e){const t=await L(e.data);S[e.data.handedness]={hand:e.data.handedness,mesh:t},this.add(t)})),o.addEventListener("disconnected",(function(){this.remove(this.children[0])})),n.add(o)}return await async function(t,n,o){return new Promise((async function(i){for(o=o||"waitUntil : timeout on condition : "+t;!t();){if(n<0)throw new Error(o);await e(300),n-=300}i()}))}((function(){return S.left&&S.right}),5e3,"Controllers not loaded (timeout)")},getXRControllers:function(){return S},getXRGamepads:function(){const e=k&&k.inputSources;if(e){const t=[e[0],e[1]].filter((e=>e)),n=t.find((e=>"left"===e.handedness)),o=t.find((e=>"right"===e.handedness));return!(!n||!o)&&{left:n,right:o}}return null},getXRSession:function(){return k},getXRCamera:function(){return renderer.xr.getCamera(x)},initMobileInput:async function(){if(!location.href.includes("localhost")){const e=window.navigator.userAgent;e.match(/iPad/i)||e.match(/iPhone/i)||document.documentElement.requestFullscreen()}j=document.createElement("div"),j.classList.add("virtual-joysticks"),document.body.appendChild(j),E.left=R("left"),j.appendChild(E.left.element),E.right=R("right"),j.appendChild(E.right.element)},getMobileJoysticksValue:function(){return{left:E.left.getVector(),right:E.right.getVector()}},getKeyboardState:()=>C};function T({platform:e,camera:t,rig:n,rigVelocity:o,collisionSystem:i}){function r(){const n=new s;return"desktop"!=e.type&&"mobile"!=e.type||(t.getWorldDirection(n),n.y=0),"vr"==e.type&&(M.getXRControllers().left.mesh.parent.getWorldDirection(n),n.multiplyScalar(-1),n.y=0),n.normalize(),n}return"desktop"!=e.type&&"mobile"!=e.type||(t.rotation.order="YXZ"),"desktop"==e.type&&(document.body.requestPointerLock(),document.body.addEventListener("mousemove",(e=>{document.pointerLockElement===document.body&&(t.rotation.y-=e.movementX/500,t.rotation.x-=-e.movementY/500)}),!1)),{update(n){if("mobile"==e.type&&(t.rotation.y-=M.getMobileJoysticksValue().right.x/30,t.rotation.x-=M.getMobileJoysticksValue().right.y/30),!i.isRigOnFloor())return;let a=0,c=0;if("desktop"==e.type){const e=M.getKeyboardState(),t=e.KeyW||e.ArrowUp?1:0,n=e.KeyS||e.ArrowDown?-1:0,o=e.KeyD||e.ArrowRight?1:0;a=t+n,c=(e.KeyA||e.ArrowLeft?-1:0)+o,c/=2}"mobile"==e.type&&(a=1.2*M.getMobileJoysticksValue().left.y,c=M.getMobileJoysticksValue().left.x/2),"vr"==e.type&&(a=-1*M.getXRGamepads().left.gamepad.axes[3],c=M.getXRGamepads().left.gamepad.axes[2]);const l=new s(0,0,0);l.add(r().multiplyScalar(a)).add(function(){const e=r();return e.cross(t.up),e}().multiplyScalar(c)).multiplyScalar(5*e.features.walk.speedFactor),o.add(l),o.multiplyScalar(.7)}}}function X({platform:e,overlay:t,camera:n,rig:o,collisionSystem:i}){window.collisionSystem=i;let r,a,c=window.rigVelocity=new s(0,0,0);return e.isEnabled("walk")&&(r=T({platform:e,camera:n,rig:o,rigVelocity:c,collisionSystem:i})),e.isEnabled("snap-turn")&&(a=function({rig:e}){let t=0;return{update(n){if((new Date).getTime()-t>200){const n=M.getXRGamepads();if(Math.abs(n.right.gamepad.axes[2])>.3){const c=n.right.gamepad.axes[2]>0?-1:1;o=e,i=M.getXRCamera().position,r=new THREE.Vector3(0,1,0),s=c*Math.PI/8,(a=void 0!==(a=!1)&&a)&&o.parent.localToWorld(o.position),o.position.sub(i),o.position.applyAxisAngle(r,s),o.position.add(i),a&&o.parent.worldToLocal(o.position),o.rotateOnAxis(r,s),t=(new Date).getTime()}}var o,i,r,s,a}}}({rig:o})),{update(t){if(e.isEnabled("walk")&&r.update(t),e.isEnabled("snap-turn")&&a.update(t),!i.isRigOnFloor()){c.y-=8*t;const e=Math.exp(-.5*t);c.x=c.x*e,c.z=c.z*e}const n=c.clone().multiplyScalar(t);o.position.add(n)}}}let A;window&&(async()=>{A="desktop";if(window.navigator.userAgent.includes("Quest"))A="vr";else if(window.document){let e=function(){A="mobile",window.document.removeEventListener("touchstart",e)};window.document.addEventListener("touchstart",e)}})();const O={platforms:{desktop:{enabled:!0,features:{walk:{enabled:!0,bind:["arrows","wasd"],speedFactor:1},jump:{enabled:!0,bind:"space"}}},vr:{enabled:!0,devices:["oculus-quest","valve-index"],features:{walk:{enabled:!0,follow:"controller-orientation",speedFactor:1},run:{enabled:!0},"snap-turn":{enabled:!0,step:Math.PI/8},jump:{enabled:!0,bind:["oculus-quest-button-A","valve-index-A-button"]},climb:{enabled:!0},fly:{enabled:!0}}},mobile:{enabled:!0,forceOrientation:"landscape",features:{walk:{enabled:!0,speedFactor:1},jump:{enabled:!0}}}},world:{gravity:9.81}};async function V(e){let t,n;if(!A)throw new Error("Cannot detect platformType, you must handle at least an user-based click before starting locomotion system");const o=e.collisionObject;e.collisionObject=void 0;const i=e.rig;e.rig=void 0;const l=e.camera;e.camera=void 0;const d=e.renderer;e.renderer=void 0;const u=(e=r(O,e)).platforms[A];return u.type=A,u.isEnabled=function(e){return u.features[e]&&u.features[e].enabled},function({renderer:e}){document.addEventListener("keydown",(e=>{C[e.code]=!0}),!1),document.addEventListener("keyup",(e=>{C[e.code]=!1}),!1)}({renderer:d}),"vr"===u.type&&(console.log("init vr session"),await M.initXRSession({renderer:d,rig:i,camera:l}),console.log("VR session started")),"mobile"===u.type&&await M.initMobileInput(),t=function({platform:e,collisionObject:t,rig:n}){const o=.35;let i=!0,r=new a;r.fromGraphNode(t);const l=new c;return{isRigOnFloor:()=>i,update(t){if("desktop"!=e.type&&"mobile"!=e.type||l.set(new s(n.position.x,n.position.y+o,n.position.z),new s(n.position.x,n.position.y+1.7-o,n.position.z),o),"vr"==e.type){const e=M.getXRCamera().position;l.set(new s(e.x,n.position.y+o,e.z),new s(e.x,e.y-o,e.z),o)}i=!1;const a=r.capsuleIntersect(l);if(a){i=a.normal.y>0;const e=a.normal.multiplyScalar(a.depth);n.position.add(e)}}}}({platform:u,collisionObject:o,rig:i}),n=X({platform:u,overlay:undefined,camera:l,rig:i,collisionSystem:t}),{update(e){n.update(e),t.update(e)},on(){},getPlatform:()=>u}}let z,F,H;window.openExample1=()=>{(new l).setPath("./").load("demo-scene/demo-scene.glb",(function(e){console.log("demo scene loaded"),function(e){document.body.innerHTML="";const t=document.createElement("div");t.innerHTML="START",t.style.fontSize="30px",t.style.cursor="pointer",t.style.background="white",t.style.padding="15px 20px",t.style.color="black",t.style.fontWeight="bold",t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate3d(-50%, -50%, 0)",document.body.appendChild(t),t.addEventListener("click",(()=>{t.remove(),e()}))}((async function(){z=new d,z.background=new u(11259375),F=window.camera=new p(50,window.innerWidth/window.innerHeight,.1,1e5),F.position.set(0,1.7,0),F.lookAt(100,0,100),H=window.renderer=new y({antialias:!1}),H.setPixelRatio(window.devicePixelRatio),H.setSize(window.innerWidth,window.innerHeight),H.outputEncoding=m,window.addEventListener("resize",(function(){F.aspect=window.innerWidth/window.innerHeight,F.updateProjectionMatrix(),H.setSize(window.innerWidth,window.innerHeight)}),!1),document.body.appendChild(H.domElement);const t=new f(4474111,1118481,1);z.add(t);const n=new w(16729156,1);n.position.set(-15,25,-5),z.add(n),z.fog=new g(11259375,0,190);const o=window.debugRig=new h;o.position.set(0,0,0),z.add(o),o.add(F),z.add(e.scene);const i=await V({collisionObject:e.scene,renderer:H,camera:F,rig:o}),r=new b;H.setAnimationLoop((function(){const e=r.getDelta();window.deltaTime=e,i.update(e),H.render(z,F)})),window.renderer1=H,window.THREE=v}))}))};
//# sourceMappingURL=index.da4a7da1.js.map
